#This file is part of Vulture OS.
#

########################## WARNING ###############################
# Don't edit this file, it is automatically generated by Vulture #
########################## WARNING ###############################


ruleset(name="{{ frontend.ruleset_name }}") {

    action(type="mmjsonparse" cookie="" container="$.parsed")

    if $parsesuccess=="OK" then {

        {% for f_reputation_ctx in frontend.reputation_ctxs %}
        {% if f_reputation_ctx.enabled %}
        action( type="mmdblookup"
                mmdbfile="{{f_reputation_ctx.reputation_ctx.absolute_filename}}"
                fields=["!ctx_tags"]
                key="$.parsed!{{f_reputation_ctx.arg_field}}")
        {% endif %}
        {% endfor %}

        {% if frontend.reputation_database_v4 %}
        action( type="mmdblookup" mmdbfile="{{frontend.reputation_database_v4}}" fields=["!reputation"] key="$.parsed!net_src_ip4" )
        {% endif %}
        {% if frontend.reputation_database_v6 %}
        action( type="mmdblookup" mmdbfile="{{frontend.reputation_database_v6}}" fields=["!reputation"] key="$.parsed!net_src_ip6" )
        {% endif %}
        {% if frontend.geoip_database %}
        action( type="mmdblookup" mmdbfile="{{frontend.geoip_database}}" fields=["!geoip"] key="$.parsed!net_src_ip4" )
        action( type="mmdblookup" mmdbfile="{{frontend.geoip_database}}" fields=["!geoip"] key="$.parsed!net_src_ip6" )
        {% endif %}

        {% include "rsyslog_darwin/ruleset.conf" %}

        set $!frontend_name = "{{frontend.name}}";

        {{ frontend.log_condition }}

        action(type="omfile" DynaFile="recoveryfile" CreateDirs="on" action.ExecOnlyWhenPreviousIsSuspended="on" template="raw_message")
        stop
    } else {
        {{ frontend.log_condition_failure }}
        #We need at least a directive here - to prevent rsyslog error
        stop
    }
}
