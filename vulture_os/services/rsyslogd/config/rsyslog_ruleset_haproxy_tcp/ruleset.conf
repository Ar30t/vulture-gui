#This file is part of Vulture OS.
#

########################## WARNING ###############################
# Don't edit this file, it is automatically generated by Vulture #
########################## WARNING ###############################


ruleset(name="{{ frontend.ruleset_name }}") {

    action(type="mmjsonparse" cookie="")

    # If log access
    if $parsesuccess=="OK" then {

        if $!server_port == "-" then {
            set $!server_port = 0;
        } else {
            set $!server_port = cnum($!server_port);
        }
        if $!backend_port == "-" then {
            set $!backend_port = 0;
        } else {
            set $!backend_port = cnum($!backend_port);
        }
        if $!darwin_reputation_error == "-" then {
            set $!darwin_reputation_error = 0;
        } else {
            set $!darwin_reputation_error = cnum($!darwin_reputation_error);
        }
        if $!darwin_reputation_score == "-" then {
            set $!darwin_reputation_score = -1;
        } else {
            set $!darwin_reputation_score = cnum($!darwin_reputation_score);
        }

        {% for f_reputation_ctx in frontend.reputation_ctxs %}
        {% if f_reputation_ctx.enabled %}
        action( type="mmdblookup"
                mmdbfile="{{f_reputation_ctx.reputation_ctx.get_filename()}}"
                fields=["!ctx_tags"]
                key="!{{f_reputation_ctx.arg_field}}")
        {% endif %}
        {% endfor %}

        {% if frontend.reputation_database_v4 -%}
        action(type="mmdblookup" mmdbfile="{{frontend.reputation_database_v4}}" fields=["!reputation"] key="!src_ip")
        {%- endif %}
        {% if frontend.reputation_database_v6 -%}
        action(type="mmdblookup" mmdbfile="{{frontend.reputation_database_v6}}" fields=["!reputation"] key="!src_ip")
        {%- endif %}
        {% if frontend.geoip_database -%}
        action(type="mmdblookup" mmdbfile="{{frontend.geoip_database}}" fields=["!country"] key="!src_ip")
        {%- endif %}

        set $!frontend_name = "{{frontend.name}}";

        {{ frontend.log_condition }}

        stop

    # If other logs
    } else {
        action(type="omfile"
               File="/var/log/haproxy/{{frontend.name}}.log"
               # FIXME : Add dirOwner, dirGroup, fileOwner, fileGroup, dirCreateMode, fileCreateMode
               flushInterval="1"
               asyncWriting="on")
    }
}
