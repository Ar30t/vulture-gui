{% if frontend.darwin_filters %}
    ###################
    # DARWIN FILTERS  #
    ###################

    {% for darwin_filter in frontend.darwin_filters -%}
    {% if darwin_filter.enabled and (darwin_input[darwin_filter.filter_type.name] is defined or darwin_filter.mmdarwin_parameters) -%}

    # FILTER {{ darwin_filter.filter.name|upper }}

    {% for inputs in darwin_input[darwin_filter.filter_type.name] -%}
    action( type="mmdarwin"
            key="{{darwin_filter.filter_type.name}}_certitude"
            socketpath="{{ darwin_filter.socket_path }}"
            response="{{ frontend.darwin_mode }}"
            fields={{ inputs | tojson }})

    {%- if frontend.darwin_mode == "back" or frontend.darwin_mode == "both" %}
    {% for input in inputs -%}
    {% set formatted_input = input.split('!')[-1] -%}
    set $!darwin!event_data!{{darwin_filter.filter.name}}!{{formatted_input | replace('.', '_')}} = cnum($!mmdarwin!{{darwin_filter.filter.name}}_certitude);
    {% endfor -%}
    {%- endif %}
    {% endfor -%}

    {% if darwin_filter.mmdarwin_enabled -%}
    # Custom call
    action( type="mmdarwin"
            key="{{darwin_filter.filter_type.name}}_certitude_custom"
            socketpath="{{ darwin_filter.socket_path }}"
            response="{{ frontend.darwin_mode }}"
            fields={{darwin_filter.mmdarwin_parameters | replace('\'', '"')}})

    {%- if frontend.darwin_mode == "back" or frontend.darwin_mode == "both" %}
    {% for input in darwin_filter.mmdarwin_parameters -%}
    {% set formatted_input = input.split('!')[-1] -%}
    set $!darwin!event_data!{{darwin_filter.filter.name}}!{{formatted_input | replace('.', '_')}} = cnum($!mmdarwin!{{darwin_filter.filter.name}}_certitude_custom);
    {% endfor -%}
    {%- endif %}
    {%- endif %}

    {% endif %}
    {% endfor %}

    # REDIS CACHING
    if $!mmdarwin!darwin_id != "" then {
        {%- if frontend.darwin_mode == "back" or frontend.darwin_mode == "both" %}
        reset $!darwin_result = exec_template("darwin_result");
        {%- endif %}

        action(type="omhiredis"
            server="127.0.0.3"
            serverport="6379"
            mode="set"
            key="darwin_redis_key"
            dynakey="on"
            expiration="10"
            template="{{frontend.ruleset}}_redis"
            action.resumeRetryCount="3"
            action.resumeInterval="1")
    }

    ######################
    # DARWIN FILTERS END #
    ######################
{% endif %}